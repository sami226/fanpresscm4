fpcm.ajax.get('editor/smileys', {
    async: false,
    data: {
        json: true
    },
    execDone: function () {
        
        var items = fpcm.ajax.getResult('editor/smileys', true);
        
        html = '';
        for(var x = 0;x < items.length; x++) {
            html += '<td class="mce-grid-cell fpcm-tinymce-emoticons">';
            html += '<a href="#">' + items[x].img + '</a>';
            html += '</td>';

            if ((x+1) % 10 == 0) {
                html += '</tr><tr>';                        
            }
        }

        fpcm.vars.jsvars.fpcm_emoticons = '<table class="mce-grid" role="list"><tbody><tr>' + html + '</tr></tbody></table>';
    }
});

tinymce.PluginManager.add("fpcm_emoticons", function (editor, t) {

    editor.addButton("emoticons", {
        type: "panelbutton",
        popoverAlign: "bc-tl",
        tooltip: "Emoticons",
        panel: {
            html: fpcm.vars.jsvars.fpcm_emoticons,
            onclick: function(e) {                
                var linkElm = editor.dom.getParent(e.target, 'img');
                if (linkElm) {
                    editor.insertContent(' ' + linkElm.getAttribute('data-smileycode') + ' ');
                    this.hide();
                }
            }
        }               
    });    
});