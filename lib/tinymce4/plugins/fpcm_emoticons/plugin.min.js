fpcm.ajax.get('editor/smileys', {
    data: {
        json: true
    }
});

tinymce.PluginManager.add("fpcm_emoticons", function (editor, t) {

    editor.addButton("emoticons", {
        type: "panelbutton",
        popoverAlign: "bc-tl",
        tooltip: "Emoticons",
        panel: {
            classes: "fpcm-ui-emoticons-panel",
            html: function () {
                var items = fpcm.ajax.getResult('editor/smileys', true);

                html = '';
                for(var x = 0;x < items.length; x++) {
                    html += '<td class="mce-grid-cell fpcm-tinymce-emoticons">';
                    html += items[x].img;
                    html += '</td>';

                    if ((x+1) % 10 == 0) {
                        html += '</tr><tr>';                        
                    }
                }

                return '<table class="mce-grid" role="list"><tbody><tr>' + html + '</tr></tbody></table>';
            },
            onclick: function(e) {                
                var linkElm = editor.dom.getParent(e.target, 'img');
                if (linkElm) {
                    editor.insertContent(' ' + linkElm.getAttribute('data-smileycode') + ' ');
                    this.hide();
                }
            }
        }               
    });    
});